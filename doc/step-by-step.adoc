                                     -*- mode:org -*-


* Creating a To Do list with the Sping Framework


** Overview

This is not a full step by step tutorial, but some notes that could
one day be expanded to be a tutorial.  So it should be complete, but
also fast to write and probably terse.

Starting with a empty pivotal tracker project with stories and such,
we build a simple To Do list app in Spring Framework + MVC, using
spring boot and AngularJS for the front end.

* Starting the project

** commit 9b8e26267780faff87e6313db3c462965d3a916e
- Github project on https://github.com/dirkjot/springdo.git
- Cleaned up tracker project and stored it in a csv file (not on
  github yet)
- Started spring boot via http://start.spring.io
- `gradle wrapper`



** commit 2c695d6db9ce111298744a1d51aea8f0f3b33a64
- `gradle idea`   , this sets up the intellij project for you.
- `idea . ` (from project directory)
- added the spring facet to the top module
- we are now using eclipse?? settings which means the project does not
  go into the `.idea` directory
- similary, build does not only go into `build` but also into `out`.
- this compiles and runs, showing an generic whitepage error on localhost:8080/
- create a run/debug configuration by right clicking on the
  spriongdoApplication.java file and choosing run, then choose the
  option with the green leaf icon (spring).   See screenshot.



** commit bea91975d47397339ef5a3e655ca1b2378c5a941

we pulled in angular + bootstrap.   following advice  from spriong
tutorial #2 (refer here),  we created our own js/css main file.   this
used wro4j in some intricate way, see springbeachproject. essentially,
it combines and minifies all js/css.

** commit ce2df0ddda289dc1c5d33b6445fe20bc80f39d42

fixed the first user story, but at json level only.  ie / returns a
json array of two todo items. 

** commit 2285a53a1a0267e14078c0553f5c41ef3ffed4f2

added some simple angular structure to iterate over the list of todo
items (using ng-repeat).  Move the json to `/resource/` . 

** commit 4c90cc917465c03c649ce0c709a8f309261c87a8

created a link with github as follows:
- go to your profile page on tracker
- find api key (long hex number)
- go to github, project setttings, webhooks and services
- under services, choose pivotal tracker and enter api key.  


** commit 4e11bb268d0fa0d4fbc005d300520c1218313fa6

- added checkboxes to UI as requested by story
- factored placeholder data to be created on application boot. 
- Created Item model and added checkboxes. 
- Selection of checkboxes is posted to the controller and persisted.
- found out how to do db init at startup, see snippet below


** commit 0a69691b627761b56237bc4bb7ac7b9b57d62706
    
Added some simple formatting to make it look nicer.  There is code in
index.html (commented out) which allows you to test the main page by
itself, without a server.


** commit 0a69691b627761b56237bc4bb7ac7b9b57d62706: working on show/hide content


what we learned about angular:
- in angular, things can be hidden/shown and toggled with ng-show and
  ng-hide directives, these can go on anything (like a <dt> in our
  case) :  <dt ng-show="toggle[item.id]"
- the ng-show has an argument which is the model variable on which it
  will show, var == true -> tag shows
- the argument is normally a variable, but can also be an array.  we
  have multiple todo items and only one toggle function, so we use an
  array with the item.id
- inside the ng.show, you do not need the {{item.id}} or $scope.
- we do need to set up the toggle array in our model (index.js):
  $scope.toggle = [];
- all array items are undefined at first, but that is fine if we want
  our item hidden: ng-show(undefined) will make things hidden.
- to toggle, we need a test that sets undefined and false to true, and
  true to false: $scope.toggle[myvar] = $scope.toggle[myvar] === true
  ? false : true;};
- the state change is started by a click on the title, you can connect
  an ng-click to ANY item (does not have to be button).
  <dt ng-click="toggleCustom(item.id)">Our ToDo title here</dt>


- stored the front end business in https://jsfiddle.net/t1q5x5g8/


*** docs used:
https://docs.angularjs.org/api/ng/directive/ngShow
http://geniuscarrier.com/ng-toggle-in-angularjs/



** commit e66aa8779b098345da115f5c23d73b25231ca36d: user edits text fields

*** design

we decided to go for an edit button , as a click on the text is nice,
but doesn't work for the title (already a collapse action).  we may
add a shortcut to edity by click on content later.

added edit and trash buttons from font awesome.

stored in jsfiddle: https://jsfiddle.net/65wbya5L/

we bolded all the item titles and removed the id numbers (dev only).
We decided against angular magic to make only the title of the
currently open todo item bold. 

The html page has become quite complex:  Each item has two forms, one
for the not-editing state (with only a checkbox as a form element) and
one for editing the title and content, with an additional edit
button. Each item has these forms, so there are a lot of forms open at
the same time.  

Each form has its own id, made up of 'form'+item.id (or 'editform').
Each of the forms points to its own model in a big array,
titleField[item.id] and contentField[item.id].  This is in addition to
a item specific toggleContent state.  These three arrays could be
avoided by treating all items as objects, with item.contentField etc. 

The editing form field could have been written much simpler by
writing: 
: <input type="text" ng-model="item.title" class="form-control">
Angular will 'live' update the item.title variable as the user is
typing, and there is no need to copy values back and forth.  However,
the drawback of this method is that you cannot undo your edits. Even
though we do not have a Cancel button in the original design, we felt
that clicking away (ie clicking on the title of another todo item),
should cancel the edit. 

To do that, we need to either  save the old value, or run the input
box on another variable.  We chose the latter, each item will be given
an inputField and titleField for editing purposes.  

 

*** docs used

http://icelab.com.au/articles/click-to-edit-with-angularjs/


** <intermediate commits>

commit e867ef62da5ec9ea5d8d99d71d70aff49b24b6b9
Author: Navya <ncanumalla@pivotal.io>
Date:   Tue Sep 22 16:08:51 2015 -0700

    Front end further improved and made much more pretty.  Small bug fixes.

commit 39b1ea432cdcfa209ef813f2f58deffa95bc4abe
Author: Navya <ncanumalla@pivotal.io>
Date:   Tue Sep 22 15:13:11 2015 -0700

    front end changes complete for editing todo items

commit 5cd646e01d299bb9e5e5e683725711afae62bd95
Author: Navya <ncanumalla@pivotal.io>
Date:   Tue Sep 22 14:21:14 2015 -0700

    #103828038-  Added glyphicons and cleaned up the html.


** commit 56dc918a833ce34e8b0aea9cf554c1d94a4497f0 save changes to back end

This is a very short commit, all we had to do was add a post to the
backend (/resource/edit/..) and write a controller to receive that
post.


** creating a new node


commit 134d6aa65b8b7555a016c62d2616f342e8598739
Author: Navya <ncanumalla@pivotal.io>
Date:   Wed Sep 23 12:31:44 2015 -0700

    Back end changes and test for new todo item; also small front end changes.

    Button still needs styling.  An error is shown in the console on submit of edit, but not solved here.

    [finishes #103828036 ]
- first thought of new endpoint
  `/resources/new/{title}/{content}/{done}/` but rejected that as the
  new button will put us in an edit form
- also, we need to get that id for the new post, only backend can do
  that
- so `/resources/create/` -> item object (json) instead.  this returns
  the item (in json) that was just created on the server.  Advantages:
  any created at/by etc headers (future fields) can be inserted by the
  server.   We can also have template notes etc etc.  
- when we get the new item, we have to insert a new bit of html, for
  which we use the minimal jquery built in to angular
- to make this all work well, we had to partial out the html that
  renders one item, so we can use it a/ in the ng-repeat when we read
  the list of existing items b/ in the new when we create a new item.
  Also , this will allow for later c/ insert a new item that was added
  by another client. 

- we found that angular is constantly rewriting the page, or at least
  checking whether it should.  so we have a ng-repeat="item in
  listofitems", where list of items is a json list of hashes with
  items (returned to us by the server).  Simply adding to this list
  will make the new item pop up, as the ng-repeat will be rerun as
  soon as the itemlist is changed.  Our mock-up add-new-item function is 
  :     $scope.plusbutton = function () { 
  :		$scope.listofitems.push({"id": 6, "title": "new item", "content": "Hi", "done": "no"});        
  :     }; 
  This and the ng-include directive were all explored in this [[https://jsfiddle.net/fngmnmve/1/][fiddle]]
  (which uses an older version of our page, so no edit button yet.)
  We started the ng-include when we were still trying to add dynamic
  content to the page with jquery/angular.element, but we left the
  partial in as it makes the page prettier.

*** resources used
- nice example of ng-include, with template in a script tag
  http://jsfiddle.net/mrajcok/mfha6/
- this very short arcticle explains how to add dynamic content to
  angular pages:  http://www.java2s.com/Tutorials/AngularJS/AngularJS_Example/Scope/Add_new_item_to_UL_list.htm



*** things learned
 
- note that ng-include expects a variable name as a src.  so if you
  know your template name you have to use 2 layers of 
  : <div ng-include src='"toBeIncluded.html"' ng-controller='ctrlA'></div>
  See [[http://stackoverflow.com/questions/13811948/different-ng-includes-on-the-same-page-how-to-send-different-variables-to-each/13812605#13812605][this SO Post]]
- adding dynamic content to the html via jquery or jqueryLite works,
  but the new html does not get interpreted by angular, ie {{var}}
  stays like that and ng-include does not work.


➜  springdo git:(master) ✗ git commit -m 'not final'
[master 94830a7] not final
 6 files changed, 123 insertions(+), 54 deletions(-)




** commit 4e04ba01f5b7f9cf0dbdb1c4e4ae107eee899b63
Author: Navya <ncanumalla@pivotal.io>
Date:   Wed Sep 23 13:55:06 2015 -0700

    added a test for the save end point

**  screenshots

project structure settings
[[./screenshots/project-structure-settings-1.png]]

run/debug configuration 
[[./screenshots/run-debug-config-1.png]]

* things to remember /snippets

** to run commands right after boot startup

make your app extend 'commandlinerunner' and then override the run method:

package io.pivotal;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.CommandLineRunner;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class SpringdoApplication implements CommandLineRunner {

    
    @Autowired
    ItemRepository itemRepository;
    
    public static void main(String[] args) {
        SpringApplication.run(SpringdoApplication.class, args);
    }

    @Override
    public void run(String... strings) throws Exception {
        // save a couple of customers
        itemRepository.save(new Item("Jack", "Bauer"));
        itemRepository.save(new Item("Chloe", "O'Brian"));
        itemRepository.save(new Item("Kim", "Bauer"));
        itemRepository.save(new Item("David", "Palmer"));
        itemRepository.save(new Item("Michelle", "Dessler"));
    }

}






** to convert an iterable (also an iterator) to a list

in java 8 , you can use a lambda and some good functional syntax:

Iterable<Item> iterable = itemRepository.findAll();
List<Item> result = new ArrayList<>();
iterable.iterator().forEachRemaining(result::add);

- the first line creates an iterable (abstract), which will be
  'instantiated' to an iterator in line 3
- the second line creates an empty list of the right type 
- the third line maps the add function of the empty list to each item
  of the iterator.
- voila

** (not solved) to refresh static items / hotswap


//    @Override
//    public void addResourceHandlers(ResourceHandlerRegistry registry) {
//        if (!registry.hasMappingForPattern("/**")) {
//            registry.addResourceHandler("/**")
//                    .addResourceLocations(
//                            this.resourceProperties.getStaticLocations())
//                    .setCachePeriod(0);
//        }
//        super.addResourceHandlers(registry);
//
//    }

* to implement later
from brian kelly's crud note video:
- endpoints should change to Create->/notes POST, Read /notes/Id GET,
  Update /notes/Id POST, Delete ..?
- use @lob annotation on large jpa fields (ie content)
- uses pegdown to allow markdown
